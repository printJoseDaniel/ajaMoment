<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Biblioteca de Lectores — Notas por Voz (Prototype)</title>
  <style>
    :root{
      --bg:#0c1b33; /* azul petróleo oscuro */
      --card:#0f2446;
      --muted:#0a1730;
      --text:#e7edf5;
      --sub:#b0bac5; /* plata */
      --accent:#d1a954; /* oro suave */
      --danger:#c0392b;
      --ok:#2ecc71;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    html,body{height:100%;}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background:linear-gradient(135deg,var(--bg),#091426 60%);
      color:var(--text);
    }
    .app{display:grid; grid-template-columns: 320px 1fr; gap:24px; padding:24px; max-width:1400px; margin:0 auto;}
    header{grid-column:1/-1; display:flex; align-items:center; justify-content:space-between; padding:18px 22px; background:var(--muted); border:1px solid #132642; border-radius:var(--radius); box-shadow:var(--shadow)}
    header .brand{display:flex; gap:14px; align-items:center}
    .logo{width:40px; height:40px; border-radius:12px; background:linear-gradient(145deg,var(--accent),#b88a3f); display:grid; place-items:center; color:#0b1426; font-weight:800}
    .brand h1{font-size:18px; margin:0}
    .brand small{color:var(--sub)}
    .actions{display:flex; gap:10px}
    button, .btn{background:var(--accent); color:#0b1426; border:none; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; box-shadow:var(--shadow); transition:transform .05s ease}
    button.secondary{background:#132642; color:var(--text); border:1px solid #1a355e}
    button.ghost{background:transparent; color:var(--sub); border:1px solid #2a4570}
    button:active{transform:translateY(1px)}

    /* Sidebar */
    .side{background:var(--muted); border:1px solid #132642; border-radius:var(--radius); box-shadow:var(--shadow); padding:18px}
    .field{display:flex; gap:10px; align-items:center; background:#0d1d39; border:1px solid #1a355e; border-radius:12px; padding:8px 10px;}
    .field input{flex:1; background:transparent; color:var(--text); border:none; outline:none; font-size:14px}
    .chips{display:flex; gap:8px; flex-wrap:wrap; margin:12px 0 4px}
    .chip{border:1px solid #1a355e; color:var(--sub); padding:6px 10px; border-radius:999px; font-size:12px; cursor:pointer}
    .chip.active{background:var(--accent); color:#0b1426; border-color:transparent}
    .list{margin-top:14px; display:grid; gap:10px; max-height:66vh; overflow:auto; padding-right:4px}
    .book{display:flex; gap:12px; align-items:center; padding:10px; border-radius:12px; border:1px solid #1a355e; background:#0e2040; cursor:pointer}
    .book.active{outline:2px solid var(--accent)}
    .cover{width:40px; height:56px; border-radius:6px; background:#12274a; display:grid; place-items:center; font-weight:800; color:#b7c3d4; letter-spacing:.5px}
    .book .meta{display:flex; flex-direction:column}
    .book .title{font-weight:700}
    .book .author{color:var(--sub); font-size:12px}

    /* Main */
    .main{display:grid; gap:16px}
    .panel{background:var(--card); border:1px solid #152a4a; border-radius:var(--radius); box-shadow:var(--shadow)}
    .panel .hd{display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid #1a355e}
    .panel .bd{padding:16px 18px}
    .grid-2{display:grid; grid-template-columns: 1.2fr 1fr; gap:16px}

    .details{display:grid; grid-template-columns:100px 1fr; gap:16px; align-items:start}
    .cover-lg{width:100px; height:140px; border-radius:8px; background:#12274a; display:grid; place-items:center; font-weight:800; color:#b7c3d4}
    .stats{display:flex; gap:10px; flex-wrap:wrap}
    .pill{border:1px solid #1a355e; background:#0d1d39; padding:6px 10px; border-radius:999px; font-size:12px; color:var(--sub)}

    .notes{display:grid; gap:10px; max-height:48vh; overflow:auto}
    .note{border:1px solid #1a355e; background:#0e2040; border-radius:12px; padding:12px}
    .note .meta{display:flex; gap:8px; align-items:center; color:var(--sub); font-size:12px; margin-bottom:6px}
    .note .text{line-height:1.5}

    .recorder{display:flex; gap:10px; align-items:center}
    .rec-dot{width:10px; height:10px; border-radius:50%; background:var(--danger); box-shadow:0 0 0 0 rgba(192,57,43,.7); animation:pulse 1.2s infinite}
    @keyframes pulse{to{box-shadow:0 0 0 12px rgba(192,57,43,0);}}
    .log{font-size:12px; color:var(--sub)}

    .textarea{width:100%; min-height:90px; resize:vertical; border-radius:12px; border:1px solid #1a355e; background:#0d1d39; color:var(--text); padding:10px}

    /* Modal */
    dialog{border:none; border-radius:16px; background:var(--card); color:var(--text); width:min(560px, 92vw); box-shadow:var(--shadow);}
    dialog::backdrop{background:rgba(2,8,18,.6)}
    .modal{padding:0}
    .modal .hd{padding:16px 18px; border-bottom:1px solid #1a355e}
    .modal .bd{padding:16px 18px; display:grid; gap:12px}
    .row{display:grid; gap:6px}
    label{font-size:13px; color:var(--sub)}
    input, select{background:#0d1d39; color:var(--text); border:1px solid #1a355e; border-radius:10px; padding:10px}

    .empty{opacity:.7; text-align:center; padding:20px 6px}
    .muted{color:var(--sub)}
    .hint{font-size:12px; color:var(--sub)}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:11px; background:#0d1d39; border:1px solid #1a355e; padding:2px 6px; border-radius:6px}

    @media (max-width: 1000px){
      .app{grid-template-columns:1fr}
      .grid-2{grid-template-columns:1fr}
    }

    /* Mobile-first tweaks */
    .mobileOnly{display:none}
    @media (max-width: 840px){
      header{flex-wrap:wrap; gap:10px}
      .actions{flex-wrap:wrap}
      .actions button{padding:12px 14px}
      .side{position:fixed; inset:0 auto 0 0; height:100dvh; width:min(88vw,420px); transform:translateX(-102%); transition:transform .2s ease; border-radius:0; overflow:auto; z-index:31}
      .side.open{transform:translateX(0)}
      .backdrop{position:fixed; inset:0; background:rgba(2,8,18,.6); z-index:30}
      .mobileOnly{display:inline-flex}
      .list{max-height:unset}
      .panel .bd{padding:14px}
      .grid-2{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="app" role="application">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">BL</div>
        <div>
          <h1>Biblioteca de Lectores</h1>
          <small class="muted">Guardar libros. Capturar aprendizajes por voz.</small>
        </div>
      </div>
      <div class="actions">
        <button class="secondary mobileOnly" id="librosBtn" title="Abrir biblioteca">Libros</button>
        <button id="addBookBtn" title="Añadir libro (A)">+ Añadir libro</button>
        <button class="secondary" id="exportBtn" title="Exportar datos">Exportar</button>
        <button class="ghost" id="importBtn" title="Importar datos">Importar</button>
        <input type="file" id="importFile" accept="application/json" hidden />
        <span id="userBadge" class="pill" hidden></span>
        <button class="secondary" id="loginBtn" title="Acceder">Acceder</button>
        <button class="ghost" id="logoutBtn" title="Salir" hidden>Salir</button>
      </div>
    </header>

    <!-- Sidebar: Library -->
    <aside class="side" aria-label="Biblioteca de libros">
      <div class="field" role="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M21 21l-4.35-4.35" stroke="#b0bac5" stroke-width="1.6" stroke-linecap="round"/><circle cx="11" cy="11" r="7" stroke="#b0bac5" stroke-width="1.6"/></svg>
        <input id="searchInput" placeholder="Buscar título o autor… ( / )" aria-label="Buscar" />
      </div>
      <div class="chips" id="filters">
        <span class="chip active" data-filter="all">Todos</span>
        <span class="chip" data-filter="no-fiction">No Ficción</span>
        <span class="chip" data-filter="ficcion">Ficción</span>
        <span class="chip" data-filter="tecnico">Técnico</span>
        <span class="chip" data-filter="otros">Otros</span>
      </div>
      <div class="list" id="bookList" aria-live="polite"></div>
      <div class="empty muted" id="emptyLibrary" hidden>
        No hay libros. Pulsa <span class="kbd">A</span> o “Añadir libro”.
      </div>
    </aside>
    <div id="drawerBackdrop" class="backdrop" hidden></div>

    <!-- Main -->
    <main class="main">
      <!-- Book Details -->
      <section class="panel" id="bookPanel" aria-label="Detalles del libro seleccionado">
        <div class="hd"><strong id="panelTitle">Selecciona un libro</strong></div>
        <div class="bd">
          <div class="empty muted" id="noBook">
            Selecciona o crea un libro para ver detalles y añadir notas.
          </div>
          <div id="bookDetails" hidden>
            <div class="details">
              <div class="cover-lg" id="detailCover">BK</div>
              <div>
                <h2 id="detailTitle" style="margin:0 0 4px 0">—</h2>
                <div class="muted" id="detailAuthor">—</div>
                <div class="stats" style="margin-top:10px">
                  <span class="pill" id="detailCategory">—</span>
                  <span class="pill" id="detailCount">0 notas</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Notes + Recorder -->
      <section class="panel" aria-label="Notas del libro">
        <div class="hd">
          <div style="display:flex; align-items:center; gap:10px">
            <strong>Notas</strong>
            <span class="hint">Dicta tus aprendizajes. Guarda solo lo útil.</span>
          </div>
          <div style="display:flex; gap:8px">
            <button class="secondary" id="startRec">Iniciar dictado</button>
            <button class="ghost" id="stopRec">Detener</button>
            <button id="saveNote">Guardar nota</button>
          </div>
        </div>
        <div class="bd grid-2">
          <div>
            <textarea id="noteInput" class="textarea" placeholder="Habla o escribe aquí…"></textarea>
            <div class="recorder" style="margin-top:10px">
              <div id="recLamp" class="rec-dot" hidden aria-hidden="true"></div>
              <div class="log" id="recLog">Dictado no iniciado.</div>
            </div>
            <div class="hint" style="margin-top:6px">
              Atajos: <span class="kbd">Ctrl</span> + <span class="kbd">Espacio</span> (iniciar/parar) · <span class="kbd">Ctrl</span> + <span class="kbd">Enter</span> (guardar)
            </div>
          </div>
          <div>
            <div id="notesList" class="notes" aria-live="polite"></div>
            <div id="noNotes" class="empty muted">Aún no hay notas para este libro.</div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Auth Modal -->
  <dialog id="authDialog" class="modal">
    <div class="hd"><strong>Accede a tu cuenta</strong></div>
    <form method="dialog" class="bd" id="authForm">
      <div class="row">
        <label for="auth_email">Email</label>
        <input id="auth_email" type="email" placeholder="tucorreo@dominio.com" required />
      </div>
      <div class="row">
        <label for="auth_pass">Contraseña</label>
        <input id="auth_pass" type="password" placeholder="••••••••" required />
      </div>
      <div class="hint" id="auth_msg"></div>
      <div style="display:flex; gap:8px; justify-content:space-between; margin-top:6px">
        <div style="display:flex; gap:8px">
          <button class="secondary" id="doLogin">Entrar</button>
          <button class="ghost" id="doRegister">Crear cuenta</button>
        </div>
        <button id="googleBtn">Google</button>
      </div>
    </form>
  </dialog>

  <!-- Add Book Modal -->
  <dialog id="addBookDialog" class="modal">
    <div class="hd"><strong>Nuevo libro</strong></div>
    <form method="dialog" class="bd" id="bookForm">
      <div class="row">
        <label for="bf_title">Título</label>
        <input id="bf_title" required placeholder="Ej. Hábitos Atómicos" />
      </div>
      <div class="row">
        <label for="bf_author">Autor</label>
        <input id="bf_author" placeholder="Ej. James Clear" />
      </div>
      <div class="row">
        <label for="bf_category">Categoría</label>
        <select id="bf_category">
          <option value="no-fiction">No Ficción</option>
          <option value="ficcion">Ficción</option>
          <option value="tecnico">Técnico</option>
          <option value="otros">Otros</option>
        </select>
      </div>
      <div class="row">
        <label for="bf_color">Color de portada</label>
        <input id="bf_color" type="color" value="#12274a" />
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:6px">
        <button class="ghost" value="cancel">Cancelar</button>
        <button id="createBookBtn" value="default">Crear</button>
      </div>
    </form>
  </dialog>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

  <script>
  // Config Firebase (sin conflictos de merge)
  window.FIREBASE_CONFIG = {
    apiKey: "AIzaSyBgSGctZ61fwyrLGEVahTQLjQTcHfHFDUQ",
    authDomain: "ajamoment-f55d8.firebaseapp.com",
    projectId: "ajamoment-f55d8"
    // storageBucket: "…",
    // messagingSenderId: "…",
    // appId: "…"
  };

  // --- Simple State & Storage ---
  const state = {
    books: [],
    notes: {}, // { [bookId]: [{id, text, ts, mode}] }
    selected: null,
    filter: 'all',
    q: ''
  };
  const LS_KEY = 'reader.voice.notes.v1';

  // --- Cloud Sync (Firebase) ---
  function updateAuthUI(u){
    const badge = document.getElementById('userBadge');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    if(!badge||!loginBtn||!logoutBtn) return;
    if(u){
      badge.hidden = false;
      badge.textContent = u.displayName || u.email || 'Cuenta';
      logoutBtn.hidden = false;
      loginBtn.hidden = true;
    } else {
      badge.hidden = true;
      logoutBtn.hidden = true;
      loginBtn.hidden = false;
    }
  }

  window.cloud = {
    inited:false, user:null, auth:null, db:null, functions:null, saveTimer:null,
    init(){
      if(this.inited) return;
      if(!window.firebase || !window.FIREBASE_CONFIG || !window.FIREBASE_CONFIG.projectId){
        console.log('Firebase no configurado: usando solo localStorage');
        updateAuthUI(null);
        this.inited = true; return;
      }
      try{
        firebase.initializeApp(window.FIREBASE_CONFIG);
        this.auth = firebase.auth();
        try { this.auth.setPersistence(firebase.auth.Auth.Persistence.SESSION); } catch(_) {}
        this.db = firebase.firestore();
        try { this.functions = (firebase.app && firebase.app().functions) ? firebase.app().functions('europe-west1') : firebase.functions(); } catch(_) { try{ this.functions = firebase.functions(); }catch(_){} }
        if(this.db && this.db.enableIndexedDbPersistence){ this.db.enableIndexedDbPersistence().catch(()=>{}); }
        this.auth.onAuthStateChanged(u=>{ this.user=u; updateAuthUI(u); if(u){ this.loadRemote(); }});
        this.inited = true;
      }catch(e){ console.warn('No se pudo iniciar Firebase', e); }
    },
    async loadRemote(){
      try{
        if(!this.user||!this.db) return;
        const docRef = this.db.collection('users').doc(this.user.uid).collection('app').doc('state');
        const snap = await docRef.get();
        if(snap.exists){
          const data = snap.data();
          if(data && data.state){ Object.assign(state, data.state); save(); renderBooks(); renderDetails(); renderNotes(); }
        } else {
          await docRef.set({ state: { books: state.books, notes: state.notes, selected: state.selected, filter: state.filter }, lastUpdated: Date.now() }, { merge:true });
        }
      }catch(e){ console.warn('Error cargando desde la nube', e); }
    },
    scheduleSave(){
      if(!this.user||!this.db) return;
      clearTimeout(this.saveTimer);
      this.saveTimer = setTimeout(()=> this.pushNow(), 500);
    },
    async pushNow(){
      try{
        if(!this.user||!this.db) return;
        const docRef = this.db.collection('users').doc(this.user.uid).collection('app').doc('state');
        await docRef.set({ state: { books: state.books, notes: state.notes, selected: state.selected, filter: state.filter }, lastUpdated: Date.now() }, { merge:true });
      }catch(e){ console.warn('Error subiendo a la nube', e); }
    },
    async transcribeBlob(blob){
      if(!this.functions) throw new Error('Configura Firebase Functions y la función sttWhisper');
      const toBase64 = (b)=> new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result.split(',')[1]); r.onerror=rej; r.readAsDataURL(b); });
      const audioB64 = await toBase64(blob);
      const callable = this.functions.httpsCallable('sttWhisper');
      const resp = await callable({ audio: audioB64, mime: blob.type || 'audio/webm' });
      return resp && resp.data && resp.data.text ? resp.data.text : '';
    },
    signInEmail(email,pass){ this.init(); return this.auth.signInWithEmailAndPassword(email,pass); },
    registerEmail(email,pass){ this.init(); return this.auth.createUserWithEmailAndPassword(email,pass); },
    signInGoogle(){ this.init(); const p=new firebase.auth.GoogleAuthProvider(); p.setCustomParameters({prompt:'select_account'}); return this.auth.signInWithPopup(p); },
    signOut(){ if(this.auth) return this.auth.signOut(); }
  };

  function uid(){ return Math.random().toString(36).slice(2,10) }
  function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); try{ if(window.cloud) cloud.scheduleSave(); }catch(e){} }
  function load(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return;
      const data = JSON.parse(raw);
      if(data.books) state.books = data.books;
      if(data.notes) state.notes = data.notes;
      if(data.selected) state.selected = data.selected;
      if(data.filter) state.filter = data.filter;
      if(data.q) state.q = data.q;
    }catch(e){ console.warn('No se pudo cargar el estado', e) }
  }

  // --- Rendering ---
  const bookList = document.getElementById('bookList');
  const emptyLibrary = document.getElementById('emptyLibrary');
  const panelTitle = document.getElementById('panelTitle');
  const noBook = document.getElementById('noBook');
  const bookDetails = document.getElementById('bookDetails');
  const detailCover = document.getElementById('detailCover');
  const detailTitle = document.getElementById('detailTitle');
  const detailAuthor = document.getElementById('detailAuthor');
  const detailCategory = document.getElementById('detailCategory');
  const detailCount = document.getElementById('detailCount');

  function renderBooks(){
    const filtered = state.books.filter(b=>{
      const passFilter = state.filter==='all' || b.category===state.filter;
      const text = (b.title + ' ' + (b.author||'')).toLowerCase();
      const passQ = !state.q || text.includes(state.q.toLowerCase());
      return passFilter && passQ;
    });

    bookList.innerHTML = '';
    if(filtered.length===0){ emptyLibrary.hidden = false; return }
    emptyLibrary.hidden = true;

    filtered.forEach(b=>{
      const row = document.createElement('div');
      row.className = 'book' + (state.selected===b.id ? ' active' : '');
      row.setAttribute('role','button');
      row.setAttribute('tabindex','0');
      row.onclick = ()=> selectBook(b.id);
      row.onkeypress = (e)=>{ if(e.key==='Enter') selectBook(b.id) };

      const cover = document.createElement('div');
      cover.className='cover';
      cover.style.background = b.color || '#12274a';
      cover.textContent = initials(b.title);

      const meta = document.createElement('div');
      meta.className='meta';
      const t = document.createElement('div'); t.className='title'; t.textContent=b.title;
      const a = document.createElement('div'); a.className='author'; a.textContent=b.author || 'Autor desconocido';
      meta.appendChild(t); meta.appendChild(a);

      row.appendChild(cover); row.appendChild(meta);
      bookList.appendChild(row);
    });
  }

  function initials(str){
    return (str||'').split(/\s+/).slice(0,2).map(s=>s[0]||'').join('').toUpperCase() || 'BK'
  }

  function selectBook(id){
    state.selected = id; save();
    renderBooks(); renderDetails(); renderNotes();
    if (window.matchMedia('(max-width: 840px)').matches) { try { closeDrawer(); } catch(_){} }
  }

  function renderDetails(){
    const b = state.books.find(x=>x.id===state.selected);
    if(!b){ noBook.hidden=false; bookDetails.hidden=true; panelTitle.textContent='Selecciona un libro'; return }
    noBook.hidden=true; bookDetails.hidden=false; panelTitle.textContent='Libro seleccionado';
    detailCover.style.background = b.color || '#12274a';
    detailCover.textContent = initials(b.title);
    detailTitle.textContent = b.title;
    detailAuthor.textContent = b.author || 'Autor desconocido';
    const catLabel = categoryLabel(b.category);
    detailCategory.textContent = catLabel; detailCategory.title = catLabel;
    const count = (state.notes[b.id]||[]).length;
    detailCount.textContent = count + (count===1?' nota':' notas');
  }

  function categoryLabel(v){
    return {
      'no-fiction':'No Ficción',
      'ficcion':'Ficción',
      'tecnico':'Técnico',
      'otros':'Otros'
    }[v] || '—'
  }

  // --- Notes ---
  const notesList = document.getElementById('notesList');
  const noNotes = document.getElementById('noNotes');
  const noteInput = document.getElementById('noteInput');

  function renderNotes(){
    const id = state.selected;
    if(!id){ notesList.innerHTML=''; noNotes.hidden=false; return }
    const notes = (state.notes[id]||[]).slice().sort((a,b)=>b.ts-a.ts);
    notesList.innerHTML='';
    if(notes.length===0){ noNotes.hidden=false; return }
    noNotes.hidden=true;

    notes.forEach(n=>{
      const el = document.createElement('div');
      el.className='note';
      const meta = document.createElement('div'); meta.className='meta';
      const mode = document.createElement('span'); mode.textContent = n.mode==='voice'?'Voz':'Escrito';
      const time = document.createElement('span'); time.textContent = new Date(n.ts).toLocaleString(); time.className='muted';
      const del = document.createElement('button'); del.className='ghost'; del.textContent='Eliminar'; del.onclick=()=>{ removeNote(id, n.id) };
      meta.appendChild(mode); meta.appendChild(document.createTextNode('· ')); meta.appendChild(time); meta.appendChild(document.createTextNode(' ')); meta.appendChild(del);

      const text = document.createElement('div'); text.className='text'; text.textContent = n.text;
      el.appendChild(meta); el.appendChild(text);
      notesList.appendChild(el);
    })
  }

  function addNote(text, mode){
    const id = state.selected;
    if(!id){ alert('Selecciona un libro primero.'); return }
    const entry = { id: uid(), text: text.trim(), mode, ts: Date.now() };
    if(!entry.text){ return }
    if(!state.notes[id]) state.notes[id] = [];
    state.notes[id].push(entry); save();
    noteInput.value='';
    renderNotes(); renderDetails();
  }

  function removeNote(bookId, noteId){
    const arr = state.notes[bookId]||[];
    const idx = arr.findIndex(n=>n.id===noteId);
    if(idx>-1){ arr.splice(idx,1); save(); renderNotes(); renderDetails(); }
  }

  // --- Recorder (Web Speech API + Fallback para Firefox) ---
  const recLamp = document.getElementById('recLamp');
  const recLog = document.getElementById('recLog');
  const startBtn = document.getElementById('startRec');
  const stopBtn = document.getElementById('stopRec');
  const saveBtn = document.getElementById('saveNote');

  let recognition = null;
  let recActive = false;
  let useWebSpeech = false;
  let mediaRecorder = null, mediaStream = null, recChunks = [];

  function setupRecognition(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){
      useWebSpeech = false;
      recLog.textContent = 'Modo voz: fallback compatible con Firefox (graba y transcribe).';
      startBtn.disabled = false; return;
    }
    useWebSpeech = true;
    recognition = new SR();
    recognition.lang = 'es-ES';
    recognition.continuous = true;
    recognition.interimResults = true;

    let buffer = '';
    recognition.onresult = (evt)=>{
      let finalChunk = '';
      for(let i=evt.resultIndex; i<evt.results.length; i++){
        const res = evt.results[i];
        const txt = res[0].transcript;
        if(res.isFinal){ finalChunk += txt + ' '; }
        else { buffer = txt; }
      }
      if(finalChunk){ noteInput.value = (noteInput.value + ' ' + finalChunk).trim(); buffer=''; }
      recLog.textContent = buffer ? 'Dictando… (intermedio: "'+ buffer.trim() +'")' : 'Dictando…';
    };
    recognition.onerror = (e)=>{
      recLog.textContent = 'Error de dictado: ' + (e.error||'desconocido');
      toggleRec(false);
    };
    recognition.onend = ()=>{
      if(recActive){ try{ recognition.start(); }catch{} }
      else { recLamp.hidden = true; recLog.textContent = 'Dictado detenido.'; }
    };
  }

  async function startFallbackRec(){
    try{
      if(!navigator.mediaDevices?.getUserMedia){ recLog.textContent = 'Micrófono no disponible.'; return; }
      mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      let mime = 'audio/webm';
      if(window.MediaRecorder && MediaRecorder.isTypeSupported){
        if(MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) mime = 'audio/webm;codecs=opus';
        else if(MediaRecorder.isTypeSupported('audio/ogg;codecs=opus')) mime = 'audio/ogg;codecs=opus';
      }
      mediaRecorder = new MediaRecorder(mediaStream, { mimeType: mime });
      recChunks = [];
      mediaRecorder.ondataavailable = (e)=>{ if(e.data?.size) recChunks.push(e.data); };
      mediaRecorder.onstop = async ()=>{
        const blob = new Blob(recChunks, { type: mime });
        recLog.textContent = 'Transcribiendo…';
        try{
          const text = await (window.cloud?.transcribeBlob ? cloud.transcribeBlob(blob) : Promise.reject(new Error('STT no configurado')));
          if(text) noteInput.value = (noteInput.value + ' ' + text).trim();
          recLog.textContent = text ? 'Transcripción lista.' : 'Sin resultado de STT.';
        }catch(err){
          recLog.textContent = 'Error transcribiendo: ' + (err?.message||err);
        }finally{ stopFallbackStream(); }
      };
      mediaRecorder.start();
      recActive = true; recLamp.hidden = false; recLog.textContent = 'Grabando…';
    }catch(err){ recLog.textContent = 'No se pudo iniciar grabación: ' + (err?.message||err); }
  }
  function stopFallbackRec(){ try{ if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop(); }catch{} recActive=false; recLamp.hidden=true; }
  function stopFallbackStream(){ try{ mediaStream?.getTracks()?.forEach(t=>t.stop()); }catch{} finally { mediaStream=null; } }

  function toggleRec(on){
    if(recognition===null && !useWebSpeech) setupRecognition();
    if(useWebSpeech){
      if(!recognition){ setupRecognition(); if(!useWebSpeech){ /* fallback */ } }
    }
    if(useWebSpeech && recognition){
      if(on){ try{ recognition.start(); recActive = true; recLamp.hidden=false; recLog.textContent='Dictando…'; }catch{} }
      else { try{ recognition.stop(); }catch{} recActive=false; recLamp.hidden=true; recLog.textContent='Dictado detenido.'; }
    } else {
      if(on) startFallbackRec(); else stopFallbackRec();
    }
  }

  // --- Add Book Modal ---
  const addBookBtn = document.getElementById('addBookBtn');
  const addBookDialog = document.getElementById('addBookDialog');
  const bookForm = document.getElementById('bookForm');
  const bf_title = document.getElementById('bf_title');
  const bf_author = document.getElementById('bf_author');
  const bf_category = document.getElementById('bf_category');
  const bf_color = document.getElementById('bf_color');

  // Auth controls
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const userBadge = document.getElementById('userBadge');
  const authDialog = document.getElementById('authDialog');
  const authEmail = document.getElementById('auth_email');
  const authPass = document.getElementById('auth_pass');
  const authMsg = document.getElementById('auth_msg');
  const doLogin = document.getElementById('doLogin');
  const doRegister = document.getElementById('doRegister');
  const googleBtn = document.getElementById('googleBtn');

  if(loginBtn){ loginBtn.addEventListener('click', ()=>{ if(window.cloud) cloud.init(); authDialog.showModal(); authEmail.focus(); }); }
  if(logoutBtn){ logoutBtn.addEventListener('click', ()=>{ if(window.cloud) cloud.signOut(); }); }
  if(doLogin){ doLogin.addEventListener('click', async (e)=>{ e.preventDefault(); authMsg.textContent=''; try{ await cloud.signInEmail(authEmail.value.trim(), authPass.value); authDialog.close(); }catch(err){ authMsg.textContent = err?.message || 'No se pudo iniciar sesión'; } }); }
  if(doRegister){ doRegister.addEventListener('click', async (e)=>{ e.preventDefault(); authMsg.textContent=''; try{ await cloud.registerEmail(authEmail.value.trim(), authPass.value); authDialog.close(); }catch(err){ authMsg.textContent = err?.message || 'No se pudo crear la cuenta'; } }); }
  if(googleBtn){ googleBtn.addEventListener('click', async (e)=>{ e.preventDefault(); try{ await cloud.signInGoogle(); authDialog.close(); }catch(err){ authMsg.textContent = err?.message || 'No se pudo acceder con Google'; } }); }

  addBookBtn.addEventListener('click', ()=>{ addBookDialog.showModal(); bf_title.focus() });

  // Mobile drawer controls
  const librosBtn = document.getElementById('librosBtn');
  const drawerBackdrop = document.getElementById('drawerBackdrop');
  const sideEl = document.querySelector('.side');

  function openDrawer(){ if(sideEl){ sideEl.classList.add('open'); if(drawerBackdrop) drawerBackdrop.hidden=false; } }
  function closeDrawer(){ if(sideEl){ sideEl.classList.remove('open'); if(drawerBackdrop) drawerBackdrop.hidden=true; } }

  if(librosBtn){ librosBtn.addEventListener('click', openDrawer); }
  if(drawerBackdrop){ drawerBackdrop.addEventListener('click', closeDrawer); }
  window.addEventListener('resize', ()=>{ if(window.innerWidth>1000) closeDrawer(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDrawer(); });

  function isEditableTarget(e){
    const el = document.activeElement || e.target;
    if(!el) return false;
    if(el.isContentEditable) return true;
    const tag = (el.tagName||'').toLowerCase();
    if(tag==='input'||tag==='textarea'||tag==='select') return true;
    if(el.closest && el.closest('[contenteditable="true"], input, textarea, select')) return true;
    return false;
  }

  document.addEventListener('keydown', (e)=>{
    // Evita atajos cuando estás escribiendo en inputs/textarea/select o contentEditable
    if(isEditableTarget(e)) return;

    // Abrir modal de nuevo libro con "A" solo si no hay otro modal abierto
    if(!addBookDialog.open && e.key.toLowerCase()==='a' && !e.metaKey && !e.ctrlKey && !e.altKey && !e.shiftKey && !e.repeat){
      e.preventDefault();
      addBookDialog.showModal();
      bf_title.focus();
    }
    // Foco en búsqueda con "/" si no estás escribiendo
    if(e.key==='/' && !e.metaKey && !e.ctrlKey && !e.altKey){
      e.preventDefault();
      document.getElementById('searchInput').focus();
    }
  });

  bookForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    const book = { id: uid(), title: bf_title.value.trim(), author: bf_author.value.trim(), category: bf_category.value, color: bf_color.value };
    if(!book.title){ return }
    state.books.push(book); if(!state.notes[book.id]) state.notes[book.id]=[];
    save(); addBookDialog.close();
    renderBooks(); selectBook(book.id); noteInput.focus();
    bookForm.reset(); bf_color.value = '#12274a';
  });

  // --- Filters & Search ---
  const filters = document.getElementById('filters');
  filters.addEventListener('click', (e)=>{
    const chip = e.target.closest('.chip'); if(!chip) return;
    [...filters.querySelectorAll('.chip')].forEach(c=>c.classList.remove('active'));
    chip.classList.add('active'); state.filter = chip.dataset.filter; save(); renderBooks();
  });

  const searchInput = document.getElementById('searchInput');
  searchInput.addEventListener('input', ()=>{ state.q = searchInput.value; renderBooks() });

  // --- Save note buttons ---
  startBtn.addEventListener('click', ()=> toggleRec(true));
  stopBtn.addEventListener('click', ()=> toggleRec(false));
  saveBtn.addEventListener('click', ()=> addNote(noteInput.value, noteInput.value? (recActive?'voice':'typed') : 'typed'));

  document.addEventListener('keydown', (e)=>{
    if(e.ctrlKey && e.code==='Space'){ e.preventDefault(); toggleRec(!recActive) }
    if(e.ctrlKey && e.code==='Enter'){ e.preventDefault(); addNote(noteInput.value, recActive?'voice':'typed') }
  });

  // --- Export / Import ---
  const exportBtn = document.getElementById('exportBtn');
  const importBtn = document.getElementById('importBtn');
  const importFile = document.getElementById('importFile');

  exportBtn.addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'biblioteca-notas.json';
    a.click();
    URL.revokeObjectURL(a.href);
  });

  importBtn.addEventListener('click', ()=> importFile.click());
  importFile.addEventListener('change', async ()=>{
    const file = importFile.files[0]; if(!file) return;
    const text = await file.text();
    try{
      const data = JSON.parse(text);
      state.books = data.books||[]; state.notes = data.notes||{}; state.selected = data.selected||null; state.filter = data.filter||'all'; state.q = '';
      save(); renderBooks(); renderDetails(); renderNotes();
    }catch(e){ alert('Archivo inválido.'); }
  });

  // --- Boot ---
  load();
  if(state.books.length===0){
    // seed with a couple of books
    const b1 = { id: uid(), title:'Hábitos Atómicos', author:'James Clear', category:'no-fiction', color:'#163b6b' };
    const b2 = { id: uid(), title:'Clean Code', author:'Robert C. Martin', category:'tecnico', color:'#2b4f7f' };
    state.books.push(b1,b2); state.notes[b1.id]=[]; state.notes[b2.id]=[]; state.selected=b1.id; save();
  }
  renderBooks(); renderDetails(); renderNotes();
  </script>
</body>
</html>

